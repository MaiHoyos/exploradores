<script>
    // Sistema de gestión de jugadores compatible con index.html
    function getCurrentPlayer() {
        try {
            return localStorage.getItem('zython-current-player');
        } catch (error) {
            console.error('Error getting current player:', error);
            return null;
        }
    }

    function loadPlayerProgress(playerName) {
        try {
            const players = JSON.parse(localStorage.getItem('zython-players') || '{}');
            return players[playerName] || {
                completedMissions: [],
                available: 1,
                completed: 0,
                badges: 0,
                currentMission: 1
            };
        } catch (error) {
            console.error('Error loading progress:', error);
            return {
                completedMissions: [],
                available: 1,
                completed: 0,
                badges: 0,
                currentMission: 1
            };
        }
    }

    function savePlayerProgress(playerName, progress) {
        try {
            const players = JSON.parse(localStorage.getItem('zython-players') || '{}');
            players[playerName] = progress;
            localStorage.setItem('zython-players', JSON.stringify(players));
            console.log('Progress saved for:', playerName, progress);
        } catch (error) {
            console.error('Error saving progress:', error);
        }
    }

    // Función para volver a misiones manteniendo la sesión
    function volverAMisiones() {
        const currentPlayer = getCurrentPlayer();
        if (currentPlayer) {
            window.location.href = `index.html?player=${encodeURIComponent(currentPlayer)}`;
        } else {
            console.warn('No current player found, going to main page');
            window.location.href = 'index.html';
        }
    }

    // Create stars background
    function createStars() {
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.width = Math.random() * 3 + 1 + 'px';
            star.style.height = star.style.width;
            star.style.animationDelay = Math.random() * 3 + 's';
            starsContainer.appendChild(star);
        }
    }

    // Check if mission is completed
    function checkCompletion() {
        const currentPlayer = getCurrentPlayer();
        if (!currentPlayer) {
            console.warn('No current player found');
            window.location.href = 'index.html';
            return;
        }

        const progress = loadPlayerProgress(currentPlayer);

        if (progress.completedMissions.includes(2)) {
            document.getElementById('completion-badge').classList.remove('hidden');
            document.getElementById('complete-btn').classList.add('hidden');
            document.getElementById('completed-btn').classList.remove('hidden');
        }
    }

    // Complete mission
    function completeMission() {
        const currentPlayer = getCurrentPlayer();
        if (!currentPlayer) {
            alert('Error: No se encontró información del jugador. Regresa al menú principal.');
            return;
        }

        const progress = loadPlayerProgress(currentPlayer);

        if (!progress.completedMissions.includes(2)) {
            progress.completedMissions.push(2);
            progress.completed = progress.completedMissions.length;
            progress.badges = progress.completedMissions.length;

            // Desbloquear siguiente misión (Misión 3)
            progress.currentMission = 3;
            progress.available = Math.max(progress.available, 3);

            savePlayerProgress(currentPlayer, progress);

            document.getElementById('completion-badge').classList.remove('hidden');
            document.getElementById('complete-btn').classList.add('hidden');
            document.getElementById('completed-btn').classList.remove('hidden');

            alert('¡Felicitaciones! Has completado la Misión 2: Paso de Zycurva. La Misión 3 ahora está disponible.');
        } else {
            alert('Esta misión ya ha sido completada anteriormente.');
        }
    }

    // Initialize
    function initialize() {
        createStars();
        checkCompletion();
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>
