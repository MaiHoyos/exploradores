<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misi√≥n 4: Estaci√≥n de Transferencia</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-purple-900 via-blue-900 to-black text-white relative overflow-auto">
    <div class="stars" id="stars"></div>
    
    <header class="relative z-10 bg-gradient-to-r from-green-400 to-green-600 border-4 border-white rounded-b-3xl p-6 m-4">
        <div class="flex items-center justify-between">
            <button onclick="volverAMisiones()" class="px-4 py-2 bg-white text-green-600 font-bold rounded-full shadow-lg transition-transform transform hover:scale-105">
                ‚Üê Volver a Misiones
            </button>
            <div class="flex items-center space-x-4">
                <div class="text-3xl font-extrabold text-white drop-shadow-lg">MISI√ìN 4</div>
                <div class="text-4xl text-yellow-300">üöõ</div>
            </div>
            <div id="completion-badge" class="hidden px-4 py-2 bg-green-500 text-white font-bold rounded-full shadow-lg">
                ‚úÖ Completada
            </div>
        </div>
    </header>

    <main class="relative z-10 p-6 md:p-10 max-w-4xl mx-auto">
        <section class="bg-white/10 backdrop-blur-sm rounded-3xl p-6 md:p-8 border-4 border-white/30 shadow-2xl mb-8">
            <h2 class="text-2xl md:text-3xl font-bold text-center mb-4 text-yellow-300">Transporte en la Estaci√≥n de Transferencia</h2>
            <p class="text-lg text-white/90 text-center mb-6">Esta es tu prueba final. Debes coordinar dos RoverBots para que trabajen en equipo, moviendo un contenedor de carga desde el punto A al punto B sin colisionar.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div>
                    <img src="mision4.png" alt="Estaci√≥n de Transferencia" class="w-full rounded-2xl border-4 border-white/50 shadow-xl" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=&quot;w-full h-auto aspect-video flex items-center justify-center text-4xl md:text-6xl bg-gradient-to-br from-pink-400 via-teal-400 to-green-400&quot;>üöõ</div>'">
                </div>
                <div class="bg-black/40 p-4 rounded-xl border-2 border-white/40">
                    <h3 class="text-xl md:text-2xl font-semibold mb-3 text-white">Objetivo de la Misi√≥n:</h3>
                    <ul class="list-disc list-inside space-y-2 text-white/90">
                        <li>Sincronizar el movimiento de dos RoverBots.</li>
                        <li>Transportar un objeto pesado.</li>
                        <li>Coordinar las acciones para evitar obst√°culos.</li>
                    </ul>
                </div>
            </div>
            
            <div class="mt-8 flex justify-center">
                <button id="complete-btn" onclick="completeMission()" class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-700 text-white font-bold text-lg rounded-full shadow-lg transition-transform transform hover:scale-110 hover:shadow-2xl">
                    Completar Misi√≥n
                </button>
                <a href="index.html" id="completed-btn" class="hidden px-6 py-3 bg-white text-green-600 font-bold text-lg rounded-full shadow-lg transition-transform transform hover:scale-110 hover:shadow-2xl">
                    Volver a Misiones
                </a>
            </div>
        </section>
        
        <section id="final-celebration" class="hidden mt-8 text-center animate-fadeIn">
            <h2 class="text-4xl md:text-5xl font-extrabold text-yellow-400 drop-shadow-xl">¬°Felicitaciones, Explorador Maestro!</h2>
            <p class="text-lg md:text-xl text-white/90 mt-4">Has completado con √©xito todas las misiones. Tu RoverBot ahora es un experto en la exploraci√≥n de Zython.</p>
        </section>
    </main>

    <script>
        function createStars() {
            const starsContainer = document.getElementById('stars');
            if (!starsContainer) return;
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Funciones para guardar y cargar el progreso en localStorage
        function getCurrentPlayer() {
            return localStorage.getItem('zython-current-player');
        }

        function loadPlayerProgress(playerName) {
            try {
                const players = JSON.parse(localStorage.getItem('zython-players') || '{}');
                return players[playerName] || { completedMissions: [], completed: 0, currentMission: 1, available: 1, badges: 0 };
            } catch (error) {
                console.error('Error loading progress:', error);
                return { completedMissions: [], completed: 0, currentMission: 1, available: 1, badges: 0 };
            }
        }

        function savePlayerProgress(playerName, progress) {
            try {
                const players = JSON.parse(localStorage.getItem('zython-players') || '{}');
                players[playerName] = progress;
                localStorage.setItem('zython-players', JSON.stringify(players));
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        // Funci√≥n para verificar si la misi√≥n ya est√° completada al cargar la p√°gina
        function checkCompletion() {
            const currentPlayer = getCurrentPlayer();
            if (currentPlayer) {
                const progress = loadPlayerProgress(currentPlayer);
                if (progress.completedMissions.includes(4)) {
                    document.getElementById('completion-badge').classList.remove('hidden');
                    document.getElementById('complete-btn').classList.add('hidden');
                    document.getElementById('completed-btn').classList.remove('hidden');
                    document.getElementById('final-celebration').classList.remove('hidden');
                }
            }
        }

        function completeMission() {
            const currentPlayer = getCurrentPlayer();
            if (!currentPlayer) {
                console.error('No current player for mission completion');
                alert('Error: No se encontr√≥ informaci√≥n del jugador. Por favor, regresa al men√∫ principal.');
                return;
            }
            
            const progress = loadPlayerProgress(currentPlayer);
            
            if (!progress.completedMissions.includes(4)) {
                progress.completedMissions.push(4);
                progress.completed = progress.completedMissions.length;
                progress.badges = progress.completedMissions.length;
                
                // This is the last mission, no more to unlock
                progress.currentMission = 4;
                
                savePlayerProgress(currentPlayer, progress);
                
                // Update UI
                document.getElementById('completion-badge').classList.remove('hidden');
                document.getElementById('complete-btn').classList.add('hidden');
                document.getElementById('completed-btn').classList.remove('hidden');
                document.getElementById('final-celebration').classList.remove('hidden');
                
                // Change button text for the final mission
                const completeBtn = document.getElementById('completed-btn');
                completeBtn.innerHTML = 'üèÜ ¬°Todas las Misiones Completadas!';
                
                // Show special completion message for final mission
                alert('üéâ ¬°FELICITACIONES! üéâ\n\nHas completado todas las misiones de Exploraci√≥n de Zython. Eres oficialmente un Maestro Explorador Espacial.\n\n¬°Tu RoverBot ahora domina todos los aspectos de la rob√≥tica educativa!');
            } else {
                alert('Esta misi√≥n ya ha sido completada anteriormente. ¬°Ya eres un Maestro Explorador de Zython!');
            }
        }

        function volverAMisiones() {
            window.location.href = 'index.html';
        }

        // Initialize
        function initialize() {
            createStars();
            checkCompletion();
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
