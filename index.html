<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exploraci√≥n de Zython - Misiones Espaciales</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Estrellas */
    .stars { position: fixed; inset: 0; pointer-events: none; }
    .star  { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite; }
    @keyframes twinkle { 0%,100%{opacity:.3} 50%{opacity:1} }

    /* Animaci√≥n planetas */
    @keyframes planetBounce { 0%,100%{ transform: translateY(0) scale(1) } 50%{ transform: translateY(-12px) scale(1.04) } }
    .animate-planet { animation: planetBounce 4s ease-in-out infinite; }

    /* Anillos */
    .ring {
      position: absolute; inset: 0; border-radius: 9999px; pointer-events: none;
      box-shadow: 0 0 0 3px rgba(255,255,255,.25) inset, 0 0 40px rgba(255,255,255,.2);
    }

    /* Para m√≥viles, tama√±os m√°s contenidos */
    @media (max-width: 768px) {
      .planet { width: 120px !important; height: 120px !important; }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-purple-900 via-blue-900 to-black text-white relative overflow-hidden">
  <!-- Fondo estrellado -->
  <div id="stars" class="stars"></div>

  <!-- Pantalla de Login -->
  <section id="login-screen" class="fixed inset-0 bg-gradient-to-b from-purple-900 via-blue-900 to-black flex items-center justify-center z-50">
    <div class="bg-white/10 backdrop-blur-md border-2 border-white/30 rounded-3xl p-8 max-w-md w-full mx-4 text-center">
      <div class="text-6xl mb-4">üöÄ</div>
      <h1 class="text-3xl font-bold mb-2">¬°Bienvenido a Zython!</h1>
      <p class="text-white/80 mb-6">Escribe tu nombre de explorador para comenzar</p>

      <div class="space-y-4">
        <input id="player-name" type="text" maxlength="20"
               placeholder="Tu nombre de explorador..."
               class="w-full px-4 py-3 rounded-xl bg-white/20 border-2 border-white/30 text-white placeholder-white/60 focus:outline-none focus:border-white/60 focus:bg-white/30 transition-all"/>
        <button id="start-game" disabled
                class="w-full px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold rounded-xl transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
          üåü Comenzar Exploraci√≥n
        </button>
      </div>
    </div>
  </section>

  <!-- Contenido del juego -->
  <section id="game-content" class="hidden">
    <!-- Header -->
    <header class="relative z-10 p-4 md:p-6">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div class="flex items-center gap-3">
          <div class="text-3xl">üöÄ</div>
          <div>
            <div class="text-xl font-bold">Exploraci√≥n de Zython</div>
            <div class="text-sm text-white/80">Misiones de Rob√≥tica Educativa</div>
          </div>
        </div>

        <div class="text-right">
          <div class="font-bold text-lg">¬°Hola <span id="player-name-display"></span>!</div>
          <div class="text-sm text-white/80">Selecciona tu pr√≥xima misi√≥n</div>
        </div>
      </div>
    </header>

    <!-- KPIs -->
    <div class="fixed top-3 right-3 z-20 bg-white/80 backdrop-blur-sm border-2 border-white/40 rounded-xl p-3 min-w-[180px]">
      <div class="grid grid-cols-3 gap-3 text-center">
        <div>
          <div id="available-count" class="text-xl font-bold text-yellow-700">1</div>
          <div class="text-[11px] text-gray-800">üéØ Disponible</div>
        </div>
        <div>
          <div id="completed-count" class="text-xl font-bold text-green-700">0</div>
          <div class="text-[11px] text-gray-800">‚≠ê Completadas</div>
        </div>
        <div>
          <div id="badges-count" class="text-xl font-bold text-purple-700">0</div>
          <div class="text-[11px] text-gray-800">üèÜ Insignias</div>
        </div>
      </div>
    </div>

    <!-- Mapa de Misiones -->
    <main class="relative z-10 max-w-6xl mx-auto px-4 pb-24">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6 md:gap-10 mt-6 md:mt-10" id="missions-grid">
        <!-- Se llena din√°micamente -->
      </div>
    </main>

    <!-- Bot√≥n Salir -->
    <button id="logout-btn" onclick="logout()"
            class="fixed bottom-4 left-4 w-12 h-12 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-50"
            title="Cerrar sesi√≥n">
      ‚èª
    </button>
  </section>

  <script>
    /************* Fondo de Estrellas *************/
    function createStars() {
      const stars = document.getElementById('stars');
      stars.innerHTML = '';
      for (let i = 0; i < 120; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        s.style.left = Math.random() * 100 + '%';
        s.style.top  = Math.random() * 100 + '%';
        const size = Math.random() * 3 + 1;
        s.style.width = size + 'px';
        s.style.height = size + 'px';
        s.style.animationDelay = (Math.random() * 3) + 's';
        stars.appendChild(s);
      }
    }

    /************* Estado *************/
    let currentPlayer = null;

    function getCurrentPlayer() {
      return localStorage.getItem('zython-current-player');
    }

    function setCurrentPlayer(name) {
      localStorage.setItem('zython-current-player', name);
    }

    function loadPlayersMap() {
      try { return JSON.parse(localStorage.getItem('zython-players') || '{}'); }
      catch { return {}; }
    }

    function savePlayersMap(map) {
      localStorage.setItem('zython-players', JSON.stringify(map));
    }

    function defaultProgress() {
      return { completedMissions: [], available: 1, completed: 0, badges: 0, currentMission: 1 };
    }

    function loadPlayerProgress(name) {
      const map = loadPlayersMap();
      return map[name] || defaultProgress();
    }

    function savePlayerProgress(name, progress) {
      const map = loadPlayersMap();
      map[name] = progress;
      savePlayersMap(map);
    }

    /************* UI: KPIs y Misiones *************/
    function updateKpis() {
      if (!currentPlayer) return;
      const p = loadPlayerProgress(currentPlayer);
      document.getElementById('available-count').textContent = p.available;
      document.getElementById('completed-count').textContent = p.completed;
      document.getElementById('badges-count').textContent    = p.badges;
    }

    const MISSIONS = [
      { id: 1, title: 'Llanura de Arranque', file: 'mision1.html', colorFrom: 'from-blue-400', colorTo: 'to-indigo-600', emoji: 'ü™ê' },
      { id: 2, title: 'Paso de Zycurva',     file: 'mision2.html', colorFrom: 'from-teal-400', colorTo: 'to-cyan-600',  emoji: 'üåÄ' },
      { id: 3, title: 'Cr√°ter del Sensorium',file: 'mision3.html', colorFrom: 'from-orange-400', colorTo: 'to-red-600', emoji: 'üåã' },
      { id: 4, title: 'Cima de Algorion',    file: 'mision4.html', colorFrom: 'from-purple-400', colorTo: 'to-pink-600', emoji: '‚ú®' }
    ];

    function renderMissions() {
      const grid = document.getElementById('missions-grid');
      grid.innerHTML = '';
      const progress = currentPlayer ? loadPlayerProgress(currentPlayer) : defaultProgress();

      MISSIONS.forEach(m => {
        const available = progress.available >= m.id;
        const completed = progress.completedMissions.includes(m.id);

        const wrap = document.createElement('div');
        wrap.className = 'flex flex-col items-center gap-3';

        const btn = document.createElement('button');
        btn.className = `
          relative planet animate-planet w-36 h-36 md:w-40 md:h-40 rounded-full 
          bg-gradient-to-br ${m.colorFrom} ${m.colorTo} 
          border-4 border-white/60 shadow-xl hover:scale-105 transition-transform
          ${available ? '' : 'opacity-50 cursor-not-allowed'}
        `;
        btn.title = available ? `Entrar a ${m.title}` : 'Misi√≥n bloqueada';
        if (available) {
          btn.onclick = () => openMission(m.id, m.file);
        }

        // Contenido planeta
        const inner = document.createElement('div');
        inner.className = 'absolute inset-0 flex flex-col items-center justify-center text-white';
        inner.innerHTML = `
          <div class="text-3xl md:text-4xl">${m.emoji}</div>
          <div class="mt-1 text-base md:text-lg font-extrabold drop-shadow">Misi√≥n ${m.id}</div>
        `;
        btn.appendChild(inner);

        // Anillo decorativo
        const ring = document.createElement('div');
        ring.className = 'ring';
        btn.appendChild(ring);

        // Estado (completada / candado)
        const badge = document.createElement('div');
        badge.className = 'absolute -top-2 -right-2';
        badge.innerHTML = completed
          ? `<div class="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full border-2 border-white shadow">‚úÖ</div>`
          : (available ? '' : `<div class="bg-gray-600 text-white text-xs font-bold px-2 py-1 rounded-full border-2 border-white shadow">üîí</div>`);
        btn.appendChild(badge);

        const caption = document.createElement('div');
        caption.className = 'text-center';
        caption.innerHTML = `
          <div class="text-sm md:text-base font-semibold">${m.title}</div>
          <div class="text-xs md:text-sm text-white/80">${available ? (completed ? 'Completada' : 'Disponible') : 'Bloqueada'}</div>
        `;

        wrap.appendChild(btn);
        wrap.appendChild(caption);
        grid.appendChild(wrap);
      });
    }

    function openMission(id, file) {
      if (!currentPlayer) {
        alert('Primero inicia sesi√≥n.');
        return;
      }
      const progress = loadPlayerProgress(currentPlayer);
      if (progress.available < id) {
        alert('Esta misi√≥n a√∫n est√° bloqueada. Completa la anterior.');
        return;
      }
      // Navega a la misi√≥n
      window.location.href = file;
    }

    /************* Login / Logout *************/
    function setupLoginUi() {
      const nameInput   = document.getElementById('player-name');
      const startButton = document.getElementById('start-game');
      const loginScreen = document.getElementById('login-screen');
      const gameContent = document.getElementById('game-content');
      const nameDisplay = document.getElementById('player-name-display');

      // Validar entrada
      nameInput.addEventListener('input', () => {
        startButton.disabled = nameInput.value.trim().length < 2;
      });

      nameInput.addEventListener('keypress', e => {
        if (e.key === 'Enter' && !startButton.disabled) startGame();
      });

      startButton.addEventListener('click', startGame);

      function startGame() {
        const name = nameInput.value.trim();
        if (name.length < 2) return;

        // Crear progreso si no existe
        const map = loadPlayersMap();
        if (!map[name]) {
          map[name] = defaultProgress();
          savePlayersMap(map);
        }

        currentPlayer = name;
        setCurrentPlayer(name);
        nameDisplay.textContent = name;

        loginScreen.classList.add('hidden');
        gameContent.classList.remove('hidden');

        updateKpis();
        renderMissions();
      }
    }

    function logout() {
      localStorage.removeItem('zython-current-player');
      currentPlayer = null;
      // Volver al login limpio
      document.getElementById('game-content').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('player-name').value = '';
      document.getElementById('start-game').disabled = true;
    }

    /************* Manejo de ?player= en la URL *************/
    function applyPlayerFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const qPlayer = params.get('player');
      if (qPlayer && qPlayer.trim().length >= 2) {
        const name = qPlayer.trim();
        const map = loadPlayersMap();
        if (!map[name]) {
          // Si viene desde una misi√≥n con nombre nuevo, crea su progreso
          map[name] = defaultProgress();
          savePlayersMap(map);
        }
        currentPlayer = name;
        setCurrentPlayer(name);
      }
    }

    /************* Inicializaci√≥n *************/
    function initialize() {
      createStars();

      // Soporte para player en query string (desde "Volver a Misiones")
      applyPlayerFromQuery();

      const saved = getCurrentPlayer();
      const loginScreen = document.getElementById('login-screen');
      const gameContent = document.getElementById('game-content');
      const nameDisplay = document.getElementById('player-name-display');

      if (saved) {
        currentPlayer = saved;
        nameDisplay.textContent = saved;
        loginScreen.classList.add('hidden');
        gameContent.classList.remove('hidden');
        updateKpis();
        renderMissions();
      } else {
        // Si no hay sesi√≥n, preparar UI de login
        setupLoginUi();
        document.getElementById('player-name').focus();
      }
    }

    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
